{% extends "base.html" %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">

    <!-- Add User Section -->
    <div class="glass-container" style="margin: 2rem auto;">
        <h2>Admin Panel</h2>
        <h3>Add New User</h3>
        <p style="margin-bottom: 20px; color: #666;">Create accounts for people you want to split bills with.</p>
        <form action="{{ url_for('add_user') }}" method="POST">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                <div class="input-group" style="margin-bottom: 0;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Username</label>
                    <input type="text" name="username" placeholder="Username" required>
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Password</label>
                    <input type="password" name="password" placeholder="Password" required>
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email (optional)</label>
                    <input type="email" name="email" placeholder="user@gmail.com">
                </div>
                <button type="submit" class="btn">Add User</button>
            </div>
        </form>
    </div>

    <!-- User Management Section -->
    <div class="glass-container" style="margin: 2rem auto;">
        <h3>User Management</h3>
        <p style="margin-bottom: 20px; color: #666;">Total Users: <strong>{{ user_stats|length }}</strong></p>

        {% if user_stats %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid rgba(0,0,0,0.1);">
                        <th style="padding: 1rem; text-align: left;">Username</th>
                        <th style="padding: 1rem; text-align: left;">Email</th>
                        <th style="padding: 1rem; text-align: right;">They Owe</th>
                        <th style="padding: 1rem; text-align: right;">Owed to Them</th>
                        <th style="padding: 1rem; text-align: right;">Net Balance</th>
                        <th style="padding: 1rem; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in user_stats %}
                    <tr style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                        <td style="padding: 1rem;"><strong>{{ stat.user.username }}</strong></td>
                        <td style="padding: 1rem; color: #666; font-size: 0.9rem;">
                            {{ stat.user.email or 'â€”' }}
                        </td>
                        <td style="padding: 1rem; text-align: right; color: #e74c3c;">
                            {% if stat.owes > 0 %}PKR {{ "%.2f"|format(stat.owes) }}{% else %}â€”{% endif %}
                        </td>
                        <td style="padding: 1rem; text-align: right; color: #2ecc71;">
                            {% if stat.owed > 0 %}PKR {{ "%.2f"|format(stat.owed) }}{% else %}â€”{% endif %}
                        </td>
                        <td style="padding: 1rem; text-align: right; font-weight: bold;">
                            {% if stat.balance > 0 %}
                            <span style="color: #2ecc71;">+PKR {{ "%.2f"|format(stat.balance) }}</span>
                            {% elif stat.balance < 0 %} <span style="color: #e74c3c;">PKR {{ "%.2f"|format(stat.balance)
                                }}</span>
                                {% else %}
                                <span style="color: #999;">PKR 0.00</span>
                                {% endif %}
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <form action="{{ url_for('delete_user', user_id=stat.user.id) }}" method="POST"
                                onsubmit="return confirm('Delete {{ stat.user.username }}? This removes all their data.');"
                                style="display: inline;">
                                <button type="submit" class="btn"
                                    style="background: linear-gradient(90deg, #e74c3c, #c0392b); padding: 0.5rem 1rem; font-size: 0.9rem;">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: #999;">
            <p>No users yet. Add your first user above!</p>
        </div>
        {% endif %}
    </div>

    <!-- Email Settings Section -->
    <div class="glass-container" style="margin: 2rem auto;">
        <h3>ðŸ“§ Email Notification Settings</h3>
        <p style="margin-bottom: 1.5rem; color: #666;">Configure automatic payment reminders for users with unpaid
            balances.</p>

        <form action="{{ url_for('save_email_settings') }}" method="POST">
            <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                <div class="input-group" style="margin-bottom: 0;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Auto-Reminder
                        Interval</label>
                    <select name="reminder_hours"
                        style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); background: var(--input-bg, #fff);">
                        <option value="6" {% if email_settings.reminder_hours==6 %}selected{% endif %}>Every 6 Hours
                        </option>
                        <option value="12" {% if email_settings.reminder_hours==12 %}selected{% endif %}>Every 12 Hours
                        </option>
                        <option value="24" {% if email_settings.reminder_hours==24 %}selected{% endif %}>Every 24 Hours
                            (Daily)</option>
                        <option value="48" {% if email_settings.reminder_hours==48 %}selected{% endif %}>Every 48 Hours
                        </option>
                        <option value="72" {% if email_settings.reminder_hours==72 %}selected{% endif %}>Every 72 Hours
                        </option>
                        <option value="168" {% if email_settings.reminder_hours==168 %}selected{% endif %}>Weekly
                        </option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; gap: 0.8rem; padding-top: 1.5rem;">
                    <input type="checkbox" name="reminders_enabled" id="reminders_enabled" {% if
                        email_settings.reminders_enabled %}checked{% endif %}
                        style="width: 20px; height: 20px; cursor: pointer;">
                    <label for="reminders_enabled" style="font-weight: 600; cursor: pointer;">Enable Automatic
                        Reminders</label>
                </div>
            </div>

            {% if email_settings.last_reminder_sent %}
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 1rem;">
                Last reminder sent: <strong>{{ email_settings.last_reminder_sent.strftime('%Y-%m-%d %H:%M') }}</strong>
            </p>
            {% endif %}

            <button type="submit" class="btn">ðŸ’¾ Save Settings</button>
        </form>

        <!-- Send Reminders Now -->
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(0,0,0,0.08);">
            <h4 style="margin: 0 0 0.5rem;">Manual Reminder</h4>
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Send a payment reminder email right now to
                all users with unpaid balances.</p>
            <form action="{{ url_for('send_reminders_now') }}" method="POST"
                onsubmit="return confirm('Send reminder emails to all users with unpaid balances?');">
                <button type="submit" class="btn" style="background: linear-gradient(90deg, #e74c3c, #c0392b);">
                    ðŸ”” Send Reminders Now
                </button>
            </form>
        </div>
    </div>

</div>

<style>
    @media (max-width: 768px) {
        div[style*="grid-template-columns: 1fr 1fr 1fr auto"] {
            grid-template-columns: 1fr !important;
        }

        div[style*="grid-template-columns: 1fr 1fr"] {
            grid-template-columns: 1fr !important;
        }

        table {
            font-size: 0.85rem;
        }

        th,
        td {
            padding: 0.5rem !important;
        }
    }
</style>
{% endblock %}