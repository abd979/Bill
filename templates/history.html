{% extends "base.html" %}

{% block content %}
<div class="glass-container" style="max-width: 1200px; margin: 2rem auto;">
    <h2>Expense History</h2>

    <!-- Search & Filter Section -->
    <form method="GET" action="{{ url_for('history') }}" style="margin-bottom: 2rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem;">
            <!-- Search -->
            <div class="input-group" style="margin-bottom: 0;">
                <label
                    style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; font-weight: 600;">Search</label>
                <input type="text" name="search" placeholder="Search description..." value="{{ search_query }}"
                    style="width: 100%;">
            </div>

            <!-- Date From -->
            <div class="input-group" style="margin-bottom: 0;">
                <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; font-weight: 600;">From
                    Date</label>
                <input type="date" name="date_from" value="{{ date_from }}" style="width: 100%;">
            </div>

            <!-- Date To -->
            <div class="input-group" style="margin-bottom: 0;">
                <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; font-weight: 600;">To
                    Date</label>
                <input type="date" name="date_to" value="{{ date_to }}" style="width: 100%;">
            </div>

            <!-- User Filter -->
            <div class="input-group" style="margin-bottom: 0;">
                <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; font-weight: 600;">Paid
                    By</label>
                <select name="user_id"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); background: var(--input-bg); color: var(--text-color);">
                    <option value="">All Users</option>
                    {% for user in all_users %}
                    <option value="{{ user.id }}" {% if user_filter==user.id|string %}selected{% endif %}>{{
                        user.username }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Status Filter -->
            <div class="input-group" style="margin-bottom: 0;">
                <label
                    style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem; font-weight: 600;">Status</label>
                <select name="status"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); background: var(--input-bg); color: var(--text-color);">
                    <option value="">All</option>
                    <option value="paid" {% if status_filter=='paid' %}selected{% endif %}>Fully Paid</option>
                    <option value="unpaid" {% if status_filter=='unpaid' %}selected{% endif %}>Has Unpaid</option>
                </select>
            </div>
        </div>

        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn" style="flex: 1;">Apply Filters</button>
            <a href="{{ url_for('history') }}" class="btn"
                style="flex: 1; background: linear-gradient(90deg, #95a5a6, #7f8c8d); text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center;">Clear
                Filters</a>
        </div>
    </form>

    <!-- Results Count -->
    <p style="color: #666; margin-bottom: 1rem;">
        <strong>{{ expenses|length }}</strong> expense(s) found
    </p>

    <!-- Expenses List -->
    {% if expenses %}
    {% for expense in expenses %}
    <div class="list-item" style="flex-direction: column; align-items: start; margin-bottom: 1.5rem;">
        <div style="width: 100%; display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <h3 style="margin: 0;">{{ expense.description }} - PKR {{ "%.2f"|format(expense.amount) }}</h3>
            <div style="display: flex; gap: 0.5rem;">
                {% if current_user.id == expense.payer_id or current_user.is_admin %}
                <a href="{{ url_for('edit_expense', expense_id=expense.id) }}" class="btn"
                    style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Edit</a>
                <form action="{{ url_for('delete_expense', expense_id=expense.id) }}" method="POST"
                    style="display: inline;"
                    onsubmit="return confirm('Are you sure you want to delete this expense? All settlements will be removed.');">
                    <button type="submit" class="btn"
                        style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: linear-gradient(90deg, #e74c3c, #c0392b);">Delete</button>
                </form>
                {% endif %}
            </div>
        </div>
        <div style="display: flex; gap: 2rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
            <small><strong>Date:</strong> {{ expense.date.strftime('%Y-%m-%d %H:%M') }}</small>
            <small><strong>Paid by:</strong> {{ expense.payer.username }}</small>
        </div>
        <div style="margin-top: 0.5rem; width: 100%;">
            <strong>Settlements:</strong>
            <div
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                {% for settlement in expense.settlements %}
                <div
                    style="background: rgba(255,255,255,0.05); padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                    {{ settlement.debtor.username }}:
                    PKR {{ "%.2f"|format(settlement.amount_due) }}
                    {% if settlement.is_paid %}
                    <span class="paid-badge" style="float: right;">Paid</span>
                    {% else %}
                    <span class="unpaid-badge" style="float: right;">Unpaid</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div style="text-align: center; padding: 3rem; color: #999;">
        <p>No expenses found matching your filters.</p>
    </div>
    {% endif %}
</div>

<style>
    /* Mobile responsiveness for filters */
    @media (max-width: 768px) {
        div[style*="grid-template-columns: 1fr 1fr 1fr 1fr auto"] {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}